# SAM2 Segmentation File Format Guide

## Overview

For SAM2 segmentation-based tracking, you need to upload an **NPZ file** (NumPy compressed archive) that contains segmentation masks generated by SAM2.

## What is an NPZ File?

- **NPZ** = **NumPy Zip** archive
- It's a compressed ZIP file containing one or more `.npy` (NumPy array) files
- Each `.npy` file stores a numpy array (like segmentation masks, centroids, etc.)
- It's the standard format for saving multiple numpy arrays together

## File Format Structure

The NPZ file should contain:

```
your_file.npz
├── masks.npy          # Segmentation masks (binary arrays)
├── centroids.npy      # Centroid coordinates for each mask
└── (optional) metadata.npy  # Additional metadata
```

### Expected Contents:

1. **Masks**: Binary or multi-class segmentation masks
   - Shape: `(N, H, W)` where N = number of masks, H = height, W = width
   - Values: 0 (background) and 1 (foreground) for binary masks
   - Or class indices for multi-class segmentation

2. **Centroids**: Center points of each segmented object
   - Shape: `(N, 2)` where N = number of masks
   - Format: `[[x1, y1], [x2, y2], ...]`

## How to Create SAM2 NPZ Files

### Option 1: Using Python with SAM2

```python
import numpy as np
from sam2.build_sam import build_sam2
from sam2.automatic_mask_generator import SAM2AutomaticMaskGenerator

# Initialize SAM2
sam2_model = build_sam2(checkpoint="path/to/sam2_checkpoint.pth")
mask_generator = SAM2AutomaticMaskGenerator(sam2_model)

# Process your image/video frame
image = cv2.imread("your_image.jpg")
masks = mask_generator.generate(image)

# Extract mask data
mask_arrays = []
centroids = []

for mask in masks:
    # Get binary mask
    mask_array = mask['segmentation'].astype(np.uint8)
    mask_arrays.append(mask_array)
    
    # Calculate centroid
    moments = cv2.moments(mask_array)
    if moments['m00'] != 0:
        cx = int(moments['m10'] / moments['m00'])
        cy = int(moments['m01'] / moments['m00'])
        centroids.append([cx, cy])

# Convert to numpy arrays
mask_arrays = np.array(mask_arrays)
centroids = np.array(centroids)

# Save as NPZ file
np.savez('sam2_segmentation.npz', 
         masks=mask_arrays, 
         centroids=centroids)
```

### Option 2: Using SAM2 Video Predictor (for video sequences)

```python
import numpy as np
from sam2.build_sam import build_sam2
from sam2.video_predictor import SAM2VideoPredictor

# Initialize SAM2 video predictor
sam2_model = build_sam2(checkpoint="path/to/sam2_checkpoint.pth")
video_predictor = SAM2VideoPredictor(sam2_model)

# Process video frames
video_path = "your_video.mp4"
masks_list = []

# Process each frame
for frame in video_frames:
    masks = video_predictor.predict(frame)
    masks_list.append(masks)

# Convert to arrays and save
masks_array = np.array(masks_list)
np.savez('sam2_video_segmentation.npz', masks=masks_array)
```

### Option 3: Manual Creation (for testing)

If you want to create a simple test file:

```python
import numpy as np

# Create dummy masks (for testing)
# Shape: (num_masks, height, width)
masks = np.zeros((2, 480, 640), dtype=np.uint8)

# Add some test regions
masks[0, 100:200, 100:200] = 1  # First mask
masks[1, 300:400, 300:400] = 1  # Second mask

# Create centroids
centroids = np.array([
    [150, 150],  # Center of first mask
    [350, 350]   # Center of second mask
])

# Save as NPZ
np.savez('test_sam2.npz', masks=masks, centroids=centroids)
```

## File Requirements

### For the Web Application:

1. **File Extension**: `.npz`
2. **File Size**: Should be reasonable (typically < 50MB for a single frame)
3. **Content**: Must contain at least:
   - `masks` array: Segmentation masks
   - `centroids` array: (Optional but recommended) Centroid coordinates

### Expected Array Shapes:

- **Masks**: 
  - Binary masks: `(N, H, W)` where values are 0 or 1
  - Multi-class: `(N, H, W)` where values are class indices
- **Centroids**: `(N, 2)` array with [x, y] coordinates

## Current Implementation Status

⚠️ **Note**: The current web implementation has a **framework** for SAM2 tracking but requires:

1. **NPZ Parser**: A JavaScript library to parse NPZ files (like `numpy-loader` or custom parser)
2. **NumPy Array Parser**: To read `.npy` files inside the NPZ archive
3. **Data Conversion**: Convert numpy arrays to OpenCV.js Mat format

### What Works Now:

- ✅ File upload interface
- ✅ Basic framework for mask-based tracking
- ✅ Placeholder visualization

### What Needs to be Added:

- ❌ Full NPZ file parsing (requires JavaScript NPZ parser)
- ❌ NumPy array format reader
- ❌ Mask overlay rendering
- ❌ Real-time mask tracking

## Example Workflow

1. **Generate SAM2 masks offline** (using Python):
   ```python
   # Process your video/image with SAM2
   masks = sam2_model.predict(frame)
   np.savez('segmentation.npz', masks=masks)
   ```

2. **Upload to web app**:
   - Select "SAM2 Segmentation" mode
   - Click "Load Segmentation"
   - Select your `.npz` file

3. **Track in real-time**:
   - The app will use the pre-computed masks for tracking
   - Masks are mapped to the current video frame

## Troubleshooting

### File Not Loading?
- Ensure file extension is `.npz`
- Check file size (shouldn't be too large)
- Verify the NPZ file contains `masks` array

### Masks Not Displaying?
- Current implementation uses placeholder visualization
- Full mask rendering requires NPZ parser implementation
- Check browser console for errors

### Creating Test Files:

For quick testing without SAM2, you can create a simple NPZ file:

```python
import numpy as np

# Create a simple test mask
mask = np.zeros((480, 640), dtype=np.uint8)
mask[200:280, 200:280] = 1  # Square region

masks = np.array([mask])  # Shape: (1, 480, 640)
centroids = np.array([[240, 240]])  # Center point

np.savez('test.npz', masks=masks, centroids=centroids)
```

## Resources

- **SAM2 GitHub**: https://github.com/facebookresearch/segment-anything-2
- **NumPy savez documentation**: https://numpy.org/doc/stable/reference/generated/numpy.savez.html
- **NPZ format**: ZIP archive containing `.npy` files

## Summary

**What you need to upload:**
- ✅ A `.npz` file
- ✅ Created using SAM2 (or manually for testing)
- ✅ Contains `masks` array (and optionally `centroids`)
- ✅ Masks should match your video frame dimensions

**Current limitation:**
- The web app currently has a framework but needs a JavaScript NPZ parser for full functionality
- For now, it demonstrates the structure and can be extended with proper NPZ parsing libraries

